# 체크리스트 통합 결정 사항

> **참고**: 이 문서는 초기 통합 계획 단계에서 작성되었습니다. `us-settlement-guide` 폴더의 데이터는 이미 데이터베이스에 마이그레이션되었고, 해당 폴더는 삭제 예정입니다.

## 1. AI 채팅 기능 통합 여부

### 현재 상황 분석

**원본 프로토타입의 AIChat 컴포넌트 (us-settlement-guide):**

- Gemini API를 사용한 AI 어시스턴트
- 체크리스트 컨텍스트를 시스템 프롬프트로 제공
- 사용자가 이주 준비 관련 질문에 즉시 답변
- 예: "SSN 신청은 어떻게 하나요?", "집 렌트 시 필요한 서류는?"

**현재 프로젝트의 ChatTab:**

- 에이전트-클라이언트 1:1 채팅 (인간 대 인간)
- Supabase `chat_rooms` 및 `chat_messages` 테이블 사용
- 폴링 방식으로 메시지 동기화 (Phase 1)
- 실시간 채팅은 Phase 2 예정

### 통합 옵션

#### 옵션 A: 통합하지 않음 (권장하지 않음)

**장점:**

- 구현 복잡도 감소
- API 비용 없음

**단점:**

- us-settlement-guide의 핵심 기능 누락
- 사용자 경험 저하 (에이전트 응답 대기 필요)
- 체크리스트와 AI 어시스턴트의 시너지 상실

#### 옵션 B: 별도 AI 채팅 탭 추가 (권장)

**구현 방식:**

- `client/home` 페이지에 "AI 어시스턴트" 탭 추가 (현재 4개 탭 → 5개 탭)
- 또는 체크리스트 탭 내부에 플로팅 버튼으로 AI 채팅 열기
- Gemini API를 Server Action으로 래핑하여 보안 처리

**장점:**

- us-settlement-guide의 모든 기능 보존
- 에이전트 채팅과 AI 채팅 분리 (명확한 역할 구분)
- 체크리스트 컨텍스트를 AI에게 제공하여 정확한 답변

**단점:**

- Gemini API 키 필요 (환경 변수 추가)
- API 호출 비용 발생 (사용량에 따라)
- 추가 구현 시간 필요

**추가 고려사항:**

- Gemini API 키는 서버 사이드에서만 사용 (보안)
- 체크리스트 데이터를 동적으로 로드하여 시스템 프롬프트에 포함
- 에러 처리: API 실패 시 친화적인 메시지 표시

#### 옵션 C: 에이전트 채팅에 AI 보조 기능 추가

**구현 방식:**

- 에이전트가 응답하지 않을 때 AI가 자동으로 답변 제안
- 또는 클라이언트가 "AI에게 물어보기" 버튼 클릭

**장점:**

- 단일 채팅 인터페이스 유지
- 에이전트와 AI의 하이브리드 경험

**단점:**

- 구현 복잡도 높음
- 사용자 혼란 가능성 (누가 답변했는지 불명확)

### 추천: 옵션 B (별도 AI 채팅 탭)

**이유:**

1. us-settlement-guide의 핵심 가치 보존
2. 사용자가 체크리스트 관련 질문에 즉시 답변 받을 수 있음
3. 에이전트 부담 감소 (반복적인 질문에 AI가 답변)
4. 구현이 상대적으로 단순 (기존 AIChat 컴포넌트 재사용)

---

## 2. 초기 체크리스트 데이터를 템플릿으로 DB에 저장할지 여부

### 현재 상황 분석

**us-settlement-guide의 CHECKLIST_DATA:**

- 총 15개 항목
- 4개 Phase: PRE_DEPARTURE (5개), ARRIVAL (4개), EARLY_SETTLEMENT (4개), SETTLEMENT_COMPLETE (1개)
- 각 항목에 상세한 description (텍스트 + subText 배열)
- category 필드 (서류 준비, 운전면허, 집 렌트 등)

**현재 DB 구조:**

- `checklist_templates` 테이블 존재
- `checklist_items`는 템플릿을 기반으로 자동 생성됨
- 기존 템플릿은 간단한 설명만 포함 (us-settlement-guide보다 상세도 낮음)

### 옵션

#### 옵션 A: 템플릿으로 저장 (권장)

**구현 방식:**

- `us-settlement-guide/constants.ts`의 모든 데이터를 `checklist_templates`에 INSERT
- `description`을 JSON 문자열로 저장 (복잡한 구조 보존)
- `sub_category` 필드에 category 값 저장 (예: "서류 준비", "운전면허")
- `category` 필드에 phase 값 저장 (예: "pre_departure", "arrival")

**장점:**

- 새 클라이언트가 가입 시 자동으로 완전한 체크리스트 생성
- 에이전트가 템플릿을 수정하면 모든 새 클라이언트에 반영
- us-settlement-guide의 모든 상세 정보 보존
- 기존 클라이언트도 템플릿 업데이트 시 새 항목 추가 가능

**단점:**

- 기존 클라이언트의 체크리스트와 불일치 가능 (해결: 마이그레이션 스크립트)
- 템플릿 관리 필요

**SQL 마이그레이션 필요:**

- 기존 템플릿 삭제 또는 업데이트
- us-settlement-guide 데이터를 템플릿으로 INSERT
- 기존 클라이언트의 체크리스트 항목 업데이트 (선택사항)

#### 옵션 B: 템플릿으로 저장하지 않음

**구현 방식:**

- 클라이언트가 체크리스트를 처음 열 때 프론트엔드에서 하드코딩된 데이터 사용
- 또는 API에서 직접 생성

**장점:**

- DB 마이그레이션 불필요
- 템플릿 관리 불필요

**단점:**

- 코드에 하드코딩 (유지보수 어려움)
- 에이전트가 템플릿 수정 불가
- 새 클라이언트마다 동일한 로직 실행 필요

### 추천: 옵션 A (템플릿으로 저장)

**이유:**

1. 기존 아키텍처와 일치 (템플릿 시스템 활용)
2. 유지보수 용이 (템플릿만 수정하면 모든 새 클라이언트에 반영)
3. 에이전트가 커스터마이징 가능
4. us-settlement-guide의 모든 상세 정보 보존

**추가 작업:**

- SQL 마이그레이션 파일 작성 (아래 제공)
- 기존 클라이언트 마이그레이션 스크립트 (선택사항)

---

## 3. 파일 크기 제한 및 허용 파일 형식

### 현재 상황 분석

**Supabase Storage 설정:**

- `uploads` 버킷: 6MB 제한 (`setup_storage.sql` 참고)
- 모든 MIME 타입 허용 (`allowed_mime_types: NULL`)

**us-settlement-guide의 파일 업로드:**

- 로컬 파일만 처리 (URL.createObjectURL)
- 실제 업로드 기능 없음

**체크리스트 파일 업로드 시나리오:**

- 서류 사진 (여권, 비자, SSN 카드 등)
- PDF 문서 (Job Offer Letter, Bank Statement 등)
- 계약서 스캔본
- 기타 증빙 서류

### 권장 사항

#### 파일 크기 제한

**현재: 6MB**

- 체크리스트 관련 서류는 대부분 6MB 이하
- 고해상도 사진도 압축 시 6MB 이내 가능
- **권장: 6MB 유지** (현재 설정 그대로)

**대안:**

- 10MB로 증가: 더 큰 PDF나 여러 페이지 스캔본 처리 가능
- 3MB로 감소: 저장 공간 절약, 업로드 속도 향상

#### 허용 파일 형식

**권장 목록:**

```
이미지: .jpg, .jpeg, .png, .webp
문서: .pdf, .doc, .docx
기타: .txt (메모용)
```

**제한 이유:**

- 보안: 실행 파일(.exe, .sh 등) 차단
- 호환성: 브라우저에서 미리보기 가능한 형식 우선
- 저장 공간: 비디오 파일 등 대용량 파일 제외

**구현 방식:**

1. 프론트엔드에서 파일 타입 검증 (`accept` 속성)
2. 서버에서 MIME 타입 재검증
3. Supabase Storage 버킷 설정 업데이트 (선택사항)

### 추천 설정

**파일 크기: 6MB 유지**

- 대부분의 서류 처리 가능
- 저장 공간 효율적

**허용 형식:**

```typescript
const ALLOWED_FILE_TYPES = [
  "image/jpeg",
  "image/jpg",
  "image/png",
  "image/webp",
  "application/pdf",
  "application/msword",
  "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
  "text/plain",
];

const MAX_FILE_SIZE = 6 * 1024 * 1024; // 6MB
```

**에러 메시지:**

- 파일 크기 초과: "파일 크기는 6MB 이하여야 합니다."
- 허용되지 않은 형식: "지원되는 파일 형식: JPG, PNG, PDF, DOC, DOCX, TXT"

---

## 결론 및 다음 단계

### 결정 요약

1. **AI 채팅**: 옵션 B (별도 AI 채팅 탭 추가) - 권장
2. **템플릿 저장**: 옵션 A (템플릿으로 저장) - 권장
3. **파일 제한**: 6MB, 이미지/문서 형식만 허용 - 권장

### 구현 우선순위

1. 템플릿 데이터 마이그레이션 (가장 먼저)
2. 체크리스트 UI 통합
3. 파일 업로드 기능
4. AI 채팅 기능 (선택사항, Phase 2로 미룰 수 있음)
